<CourseFloatingBanner chapter={2}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/agents-course/blob/main/notebooks/unit2/smolagents/retrieval_agents.ipynb"},
]} />

# Construyendo Sistemas RAG con Agentes

<Tip>
Puedes seguir el c贸digo en <a href="https://huggingface.co/agents-course/notebooks/blob/main/unit2/smolagents/retrieval_agents.ipynb" target="_blank">este notebook</a> que puedes ejecutar usando Google Colab.
</Tip>

Los sistemas de Generaci贸n Aumentada por Recuperaci贸n (RAG) combinan las capacidades de recuperaci贸n de datos y modelos de generaci贸n para proporcionar respuestas contextualizadas. Por ejemplo, la consulta de un usuario se pasa a un motor de b煤squeda, y los resultados recuperados se entregan al modelo junto con la consulta. El modelo luego genera una respuesta basada en la consulta y la informaci贸n recuperada.

El RAG con Agentes (Generaci贸n Aumentada por Recuperaci贸n) extiende los sistemas RAG tradicionales al **combinar agentes aut贸nomos con recuperaci贸n din谩mica de conocimiento**.

Mientras que los sistemas RAG tradicionales utilizan un LLM para responder consultas basadas en datos recuperados, el RAG con agentes **permite un control inteligente tanto de los procesos de recuperaci贸n como de generaci贸n**, mejorando la eficiencia y precisi贸n.

Los sistemas RAG tradicionales enfrentan limitaciones clave, como **depender de un solo paso de recuperaci贸n** y enfocarse en la similitud sem谩ntica directa con la consulta del usuario, lo que puede pasar por alto informaci贸n relevante.

El RAG con agentes aborda estos problemas permitiendo que el agente formule aut贸nomamente consultas de b煤squeda, critique los resultados recuperados y realice m煤ltiples pasos de recuperaci贸n para obtener un resultado m谩s personalizado y completo.

## Recuperaci贸n B谩sica con DuckDuckGo

Vamos a construir un agente simple que pueda buscar en la web usando DuckDuckGo. Este agente recuperar谩 informaci贸n y sintetizar谩 respuestas para contestar consultas. Con RAG con agentes, el agente de Alfred puede:

* Buscar las 煤ltimas tendencias en fiestas de superh茅roes
* Refinar resultados para incluir elementos de lujo
* Sintetizar informaci贸n en un plan completo

As铆 es como el agente de Alfred puede lograr esto:

```python
from smolagents import CodeAgent, DuckDuckGoSearchTool, HfApiModel

# Initialize the search tool
search_tool = DuckDuckGoSearchTool()

# Initialize the model
model = HfApiModel()

agent = CodeAgent(
    model=model,
    tools=[search_tool]
)

# Example usage
response = agent.run(
    "Buscar ideas de fiesta tem谩tica de superh茅roes de lujo, incluyendo decoraci贸n, entretenimiento y catering."
)
print(response)
```

El agente sigue este proceso:

1. **Analiza la Solicitud:** El agente de Alfred identifica los elementos clave de la consultaplanificaci贸n de fiesta tem谩tica de superh茅roes de lujo, con enfoque en decoraci贸n, entretenimiento y catering.
2. **Realiza la Recuperaci贸n:** El agente utiliza DuckDuckGo para buscar la informaci贸n m谩s relevante y actualizada, asegur谩ndose de que se alinee con las preferencias refinadas de Alfred para un evento lujoso.
3. **Sintetiza la Informaci贸n:** Despu茅s de recopilar los resultados, el agente los procesa en un plan coherente y accionable para Alfred, cubriendo todos los aspectos de la fiesta.
4. **Almacena para Referencia Futura:** El agente almacena la informaci贸n recuperada para un f谩cil acceso al planificar eventos futuros, optimizando la eficiencia en tareas posteriores.

## Herramienta de Base de Conocimiento Personalizada

Para tareas especializadas, una base de conocimiento personalizada puede ser invaluable. Vamos a crear una herramienta que consulte una base de datos vectorial de documentaci贸n t茅cnica o conocimiento especializado. Utilizando b煤squeda sem谩ntica, el agente puede encontrar la informaci贸n m谩s relevante para las necesidades de Alfred.

Una base de datos vectorial es simplemente una colecci贸n de documentos con representaciones enriquecidas por modelos de ML especializados, que permiten la b煤squeda y recuperaci贸n r谩pida de los documentos.

Este enfoque combina conocimiento predefinido con b煤squeda sem谩ntica para proporcionar soluciones contextualizadas para la planificaci贸n de eventos. Con acceso a conocimiento especializado, Alfred puede perfeccionar cada detalle de la fiesta.

En este ejemplo, crearemos una herramienta que recupera ideas de planificaci贸n de fiestas desde una base de conocimiento personalizada. Usaremos un recuperador BM25 para buscar en la base de conocimiento y devolver los mejores resultados, y `RecursiveCharacterTextSplitter` para dividir los documentos en fragmentos m谩s peque帽os para una b煤squeda m谩s eficiente.

```python
from langchain.docstore.document import Document
from langchain.text_splitter import RecursiveCharacterTextSplitter
from smolagents import Tool
from langchain_community.retrievers import BM25Retriever
from smolagents import CodeAgent, HfApiModel

class PartyPlanningRetrieverTool(Tool):
    name = "party_planning_retriever"
    description = "Utiliza b煤squeda sem谩ntica para recuperar ideas de planificaci贸n de fiestas relevantes para la fiesta tem谩tica de superh茅roes de Alfred en Wayne Manor."
    inputs = {
        "query": {
            "type": "string",
            "description": "La consulta a realizar. Esta debe ser una consulta relacionada con la planificaci贸n de fiestas o temas de superh茅roes.",
        }
    }
    output_type = "string"

    def __init__(self, docs, **kwargs):
        super().__init__(**kwargs)
        self.retriever = BM25Retriever.from_documents(
            docs, k=5  # Retrieve the top 5 documents
        )

    def forward(self, query: str) -> str:
        assert isinstance(query, str), "Tu consulta de b煤squeda debe ser una cadena"

        docs = self.retriever.invoke(
            query,
        )
        return "\nIdeas recuperadas:\n" + "".join(
            [
                f"\n\n===== Idea {str(i)} =====\n" + doc.page_content
                for i, doc in enumerate(docs)
            ]
        )

# Simulate a knowledge base about party planning
party_ideas = [
    {"text": "Una fiesta de disfraces tem谩tica de superh茅roes con decoraci贸n de lujo, incluyendo detalles dorados y cortinas de terciopelo.", "source": "Ideas de fiesta 1"},
    {"text": "Contrata a un DJ profesional que pueda tocar m煤sica tem谩tica para superh茅roes como Batman y Wonder Woman.", "source": "Ideas de entretenimiento"},
    {"text": "Para el catering, sirve platos con nombres de superh茅roes, como 'El smoothie verde de Hulk' y 'El filete de poder de Iron Man'.", "source": "Ideas de catering"},
    {"text": "Decora con logotipos ic贸nicos de superh茅roes y proyecciones de Gotham y otras ciudades de superh茅roes alrededor del lugar.", "source": "Ideas de decoraci贸n"},
    {"text": "Experiencias interactivas con realidad virtual donde los invitados pueden participar en simulaciones de superh茅roes o competir en juegos tem谩ticos.", "source": "Ideas de entretenimiento"}
]

source_docs = [
    Document(page_content=doc["text"], metadata={"source": doc["source"]})
    for doc in party_ideas
]

# Split the documents into smaller chunks for more efficient search
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=50,
    add_start_index=True,
    strip_whitespace=True,
    separators=["\n\n", "\n", ".", " ", ""],
)
docs_processed = text_splitter.split_documents(source_docs)

# Create the retriever tool
party_planning_retriever = PartyPlanningRetrieverTool(docs_processed)

# Initialize the agent
agent = CodeAgent(tools=[party_planning_retriever], model=HfApiModel())

# Example usage
response = agent.run(
    "Encuentra ideas para una fiesta tem谩tica de superh茅roes de lujo, incluyendo entretenimiento, catering y opciones de decoraci贸n."
)

print(response)
```

Este agente mejorado puede:
1. Primero verificar la documentaci贸n para obtener informaci贸n relevante
2. Combinar ideas de la base de conocimiento
3. Mantener el contexto de la conversaci贸n en memoria

## Capacidades de Recuperaci贸n Mejoradas

Al construir sistemas RAG con agentes, el agente puede emplear estrategias sofisticadas como:

1. **Reformulaci贸n de Consultas:** En lugar de usar la consulta del usuario en bruto, el agente puede elaborar t茅rminos de b煤squeda optimizados que coincidan mejor con los documentos objetivo
2. **Recuperaci贸n Multi-Paso:** El agente puede realizar m煤ltiples b煤squedas, utilizando los resultados iniciales para informar consultas posteriores
3. **Integraci贸n de Fuentes:** La informaci贸n puede combinarse de m煤ltiples fuentes como b煤squeda web y documentaci贸n local
4. **Validaci贸n de Resultados:** El contenido recuperado puede analizarse para determinar su relevancia y precisi贸n antes de incluirlo en las respuestas

Los sistemas RAG con agentes efectivos requieren una consideraci贸n cuidadosa de varios aspectos clave. El agente **debe seleccionar entre las herramientas disponibles seg煤n el tipo de consulta y el contexto**. Los sistemas de memoria ayudan a mantener el historial de conversaci贸n y evitar recuperaciones repetitivas. Tener estrategias de respaldo garantiza que el sistema pueda seguir proporcionando valor incluso cuando los m茅todos de recuperaci贸n principales fallan. Adem谩s, implementar pasos de validaci贸n ayuda a garantizar la precisi贸n y relevancia de la informaci贸n recuperada.

## Recursos

- [RAG con Agentes: 隆potencia tu RAG con reformulaci贸n de consultas y auto-consulta! ](https://huggingface.co/learn/cookbook/agent_rag) - Receta para desarrollar un sistema RAG con Agentes utilizando smolagents.
