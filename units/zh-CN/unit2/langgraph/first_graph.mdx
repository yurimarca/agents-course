# æ„å»ºä½ çš„ç¬¬ä¸€ä¸ª LangGraph

ç°åœ¨æˆ‘ä»¬å·²ç»ç†è§£äº†åŸºæœ¬æ„å»ºæ¨¡å—ï¼Œè®©æˆ‘ä»¬é€šè¿‡æ„å»ºç¬¬ä¸€ä¸ªåŠŸèƒ½å›¾æ¥å®è·µã€‚æˆ‘ä»¬å°†å®ç° Alfred çš„é‚®ä»¶å¤„ç†ç³»ç»Ÿï¼Œä»–éœ€è¦ï¼š

1. é˜…è¯» incoming emails
2. å°†å…¶åˆ†ç±»ä¸º spam æˆ– legitimate
3. ä¸º legitimate é‚®ä»¶èµ·è‰åˆæ­¥å“åº”
4. å½“é‚®ä»¶åˆæ³•æ—¶å‘ Mr. Wayne å‘é€ä¿¡æ¯ï¼ˆä»…æ‰“å°ï¼‰

è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ LangGraph æ„å»ºæ¶‰åŠåŸºäº LLM å†³ç­–çš„å·¥ä½œæµç¨‹ç»“æ„ã€‚è™½ç„¶è¿™ä¸èƒ½ç®—æ˜¯çœŸæ­£çš„ Agentï¼ˆå› ä¸ºæ²¡æœ‰æ¶‰åŠå·¥å…·ï¼‰ï¼Œä½†æœ¬èŠ‚æ›´ä¾§é‡äºå­¦ä¹  LangGraph æ¡†æ¶è€Œé Agentsã€‚

<Tip>
ä½ å¯ä»¥åœ¨ <a href="https://huggingface.co/agents-course/notebooks/resolve/main/unit2/langgraph/mail_sorting.ipynb" target="_blank">è¿™ä¸ª notebook</a> ä¸­æŸ¥çœ‹å®Œæ•´ä»£ç ï¼Œå¹¶é€šè¿‡ Google Colab è¿è¡Œã€‚
</Tip>

## å·¥ä½œæµç¨‹
è¿™æ˜¯æˆ‘ä»¬å°†è¦æ„å»ºçš„å·¥ä½œæµç¨‹ï¼š
<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit2/LangGraph/first_graph.png" alt="First LangGraph"/>

## ç¯å¢ƒè®¾ç½®

é¦–å…ˆå®‰è£…å¿…è¦çš„åŒ…ï¼š

```python
%pip install langgraph langchain_openai
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å¯¼å…¥å¿…è¦çš„æ¨¡å—ï¼š

```python
import os
from typing import TypedDict, List, Dict, Any, Optional
from langgraph.graph import StateGraph, END
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, AIMessage
```

## æ­¥éª¤ 1ï¼šå®šä¹‰æˆ‘ä»¬çš„çŠ¶æ€

è®©æˆ‘ä»¬å®šä¹‰ Alfred åœ¨ç”µå­é‚®ä»¶å¤„ç†å·¥ä½œæµç¨‹ä¸­éœ€è¦è·Ÿè¸ªå“ªäº›ä¿¡æ¯ï¼š

```python
class EmailState(TypedDict):
    # æ­£åœ¨å¤„ç†çš„ç”µå­é‚®ä»¶
    email: Dict[str, Any]  # åŒ…å«ä¸»é¢˜ã€å‘ä»¶äººã€æ­£æ–‡ç­‰ã€‚
    
    # åˆ†æä¸å†³ç­–
    is_spam: Optional[bool]
    
    # å“åº”ç”Ÿæˆ
    draft_response: Optional[str]
    
    # å¤„ç†å…ƒæ•°æ®
    messages: List[Dict[str, Any]]  # è·Ÿè¸ªä¸ LLM çš„å¯¹è¯ä»¥è¿›è¡Œåˆ†æ
```

> ğŸ’¡ **æç¤ºï¼š**è®©æ‚¨çš„çŠ¶æ€è¶³å¤Ÿå…¨é¢ï¼Œä»¥è·Ÿè¸ªæ‰€æœ‰é‡è¦ä¿¡æ¯ï¼Œä½†é¿å…ç”¨ä¸å¿…è¦çš„ç»†èŠ‚ä½¿å…¶å˜å¾—è‡ƒè‚¿ã€‚

## ç¬¬ 2 æ­¥ï¼šå®šä¹‰æˆ‘ä»¬çš„èŠ‚ç‚¹

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºå°†å½¢æˆæˆ‘ä»¬èŠ‚ç‚¹çš„å¤„ç†å‡½æ•°ï¼š

```python
# Initialize our LLM
model = ChatOpenAI(temperature=0)

def read_email(state: EmailState):
    """Alfred reads and logs the incoming email"""
    email = state["email"]
    
    # åœ¨è¿™é‡Œæˆ‘ä»¬å¯èƒ½ä¼šåšä¸€äº›åˆæ­¥çš„é¢„å¤„ç†
    print(f"Alfred is processing an email from {email['sender']} with subject: {email['subject']}")
    
    # è¿™é‡Œä¸éœ€è¦æ›´æ”¹çŠ¶æ€
    return {}

def classify_email(state: EmailState):
    """Alfred uses an LLM to determine if the email is spam or legitimate"""
    email = state["email"]
    
    # ä¸º LLM å‡†å¤‡æç¤º
    prompt = f"""
    As Alfred the butler, analyze this email and determine if it is spam or legitimate.
    
    Email:
    From: {email['sender']}
    Subject: {email['subject']}
    Body: {email['body']}
    
    First, determine if this email is spam. If it is spam, explain why.
    If it is legitimate, categorize it (inquiry, complaint, thank you, etc.).
    """
    
    # Call the LLM
    messages = [HumanMessage(content=prompt)]
    response = model.invoke(messages)
    
    # è§£æå“åº”çš„ç®€å•é€»è¾‘ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦æ›´å¼ºå¤§çš„è§£æï¼‰
    response_text = response.content.lower()
    is_spam = "spam" in response_text and "not spam" not in response_text
    
    # å¦‚æœæ˜¯åƒåœ¾é‚®ä»¶ï¼Œè¯·æå–åŸå› 
    spam_reason = None
    if is_spam and "reason:" in response_text:
        spam_reason = response_text.split("reason:")[1].strip()
    
    # ç¡®å®šç±»åˆ«æ˜¯å¦åˆæ³•
    email_category = None
    if not is_spam:
        categories = ["inquiry", "complaint", "thank you", "request", "information"]
        for category in categories:
            if category in response_text:
                email_category = category
                break
    
    # æ›´æ–°æ¶ˆæ¯ä»¥è¿›è¡Œè¿½è¸ª
    new_messages = state.get("messages", []) + [
        {"role": "user", "content": prompt},
        {"role": "assistant", "content": response.content}
    ]
    
    # è¿”å›çŠ¶æ€æ›´æ–°
    return {
        "is_spam": is_spam,
        "spam_reason": spam_reason,
        "email_category": email_category,
        "messages": new_messages
    }

def handle_spam(state: EmailState):
    """Alfred discards spam email with a note"""
    print(f"Alfred has marked the email as spam. Reason: {state['spam_reason']}")
    print("The email has been moved to the spam folder.")
    
    # æˆ‘ä»¬å·²å¤„ç†å®Œè¿™å°ç”µå­é‚®ä»¶
    return {}

def draft_response(state: EmailState):
    """Alfred drafts a preliminary response for legitimate emails"""
    email = state["email"]
    category = state["email_category"] or "general"
    
    # ä¸º LLM å‡†å¤‡æç¤ºè¯
    prompt = f"""
    As Alfred the butler, draft a polite preliminary response to this email.
    
    Email:
    From: {email['sender']}
    Subject: {email['subject']}
    Body: {email['body']}
    
    This email has been categorized as: {category}
    
    Draft a brief, professional response that Mr. Hugg can review and personalize before sending.
    """
    
    # Call the LLM
    messages = [HumanMessage(content=prompt)]
    response = model.invoke(messages)
    
    # æ›´æ–°æ¶ˆæ¯ä»¥è¿›è¡Œè¿½è¸ª
    new_messages = state.get("messages", []) + [
        {"role": "user", "content": prompt},
        {"role": "assistant", "content": response.content}
    ]
    
    # è¿”å›çŠ¶æ€æ›´æ–°
    return {
        "draft_response": response.content,
        "messages": new_messages
    }

def notify_mr_hugg(state: EmailState):
    """Alfred notifies Mr. Hugg about the email and presents the draft response"""
    email = state["email"]
    
    print("\n" + "="*50)
    print(f"Sir, you've received an email from {email['sender']}.")
    print(f"Subject: {email['subject']}")
    print(f"Category: {state['email_category']}")
    print("\nI've prepared a draft response for your review:")
    print("-"*50)
    print(state["draft_response"])
    print("="*50 + "\n")
    
    # æˆ‘ä»¬å·²å¤„ç†å®Œè¿™å°ç”µå­é‚®ä»¶
    return {}
```

## æ­¥éª¤ 3ï¼šå®šä¹‰æˆ‘ä»¬çš„è·¯ç”±é€»è¾‘

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥ç¡®å®šåˆ†ç±»åè¦é‡‡å–å“ªæ¡è·¯å¾„ï¼š

```python
def route_email(state: EmailState) -> str:
    """Determine the next step based on spam classification"""
    if state["is_spam"]:
        return "spam"
    else:
        return "legitimate"
```

> ğŸ’¡ **æ³¨æ„ï¼š** LangGraph è°ƒç”¨æ­¤è·¯ç”±å‡½æ•°æ¥ç¡®å®šåœ¨åˆ†ç±»èŠ‚ç‚¹ä¹‹åè¦è·Ÿéšå“ªæ¡è¾¹ã€‚è¿”å›å€¼å¿…é¡»ä¸æˆ‘ä»¬çš„æ¡ä»¶è¾¹æ˜ å°„ä¸­çš„ä¸€ä¸ªé”®åŒ¹é…ã€‚

## æ­¥éª¤ 4ï¼šåˆ›å»º StateGraph å¹¶å®šä¹‰è¾¹

ç°åœ¨æˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹è¿æ¥åœ¨ä¸€èµ·ï¼š

```python
# åˆ›å»º graph
email_graph = StateGraph(EmailState)

# æ·»åŠ  nodes
email_graph.add_node("read_email", read_email)
email_graph.add_node("classify_email", classify_email)
email_graph.add_node("handle_spam", handle_spam)
email_graph.add_node("draft_response", draft_response)
email_graph.add_node("notify_mr_hugg", notify_mr_hugg)

# æ·»åŠ  edges - å®šä¹‰æµç¨‹
email_graph.add_edge("read_email", "classify_email")

# ä» classify_email æ·»åŠ æ¡ä»¶åˆ†æ”¯
email_graph.add_conditional_edges(
    "classify_email",
    route_email,
    {
        "spam": "handle_spam",
        "legitimate": "draft_response"
    }
)

# æ·»åŠ æœ€åçš„ edges
email_graph.add_edge("handle_spam", END)
email_graph.add_edge("draft_response", "notify_mr_hugg")
email_graph.add_edge("notify_mr_hugg", END)

# ç¼–è¯‘ graph
compiled_graph = email_graph.compile()
```

æ³¨æ„æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ LangGraph æä¾›çš„ç‰¹æ®Šâ€œENDâ€èŠ‚ç‚¹ã€‚è¿™è¡¨ç¤ºå·¥ä½œæµå®Œæˆçš„ç»ˆç«¯çŠ¶æ€ã€‚

## æ­¥éª¤ 5ï¼šè¿è¡Œåº”ç”¨ç¨‹åº

è®©æˆ‘ä»¬ç”¨ä¸€å°åˆæ³•çš„ç”µå­é‚®ä»¶å’Œä¸€å°åƒåœ¾é‚®ä»¶æ¥æµ‹è¯•æˆ‘ä»¬çš„å›¾è¡¨ï¼š

```python
# åˆæ³•ç”µå­é‚®ä»¶ç¤ºä¾‹
legitimate_email = {
    "sender": "john.smith@example.com",
    "subject": "Question about your services",
    "body": "Dear Mr. Hugg, I was referred to you by a colleague and I'm interested in learning more about your consulting services. Could we schedule a call next week? Best regards, John Smith"
}

# åƒåœ¾é‚®ä»¶ç¤ºä¾‹
spam_email = {
    "sender": "winner@lottery-intl.com",
    "subject": "YOU HAVE WON $5,000,000!!!",
    "body": "CONGRATULATIONS! You have been selected as the winner of our international lottery! To claim your $5,000,000 prize, please send us your bank details and a processing fee of $100."
}

# å¤„ç†åˆæ³•ç”µå­é‚®ä»¶
print("\nProcessing legitimate email...")
legitimate_result = compiled_graph.invoke({
    "email": legitimate_email,
    "is_spam": None,
    "spam_reason": None,
    "email_category": None,
    "draft_response": None,
    "messages": []
})

# å¤„ç†åƒåœ¾é‚®ä»¶
print("\nProcessing spam email...")
spam_result = compiled_graph.invoke({
    "email": spam_email,
    "is_spam": None,
    "spam_reason": None,
    "email_category": None,
    "draft_response": None,
    "messages": []
})
```

## ç¬¬ 6 æ­¥ï¼šä½¿ç”¨ Langfuse æ£€æŸ¥æˆ‘ä»¬çš„é‚®ä»¶åˆ†ç±»æ™ºèƒ½ä½“ ğŸ“¡

éšç€ Alfred å¯¹ä¸»åˆ†ç±»æ™ºèƒ½ä½“è¿›è¡Œå¾®è°ƒï¼Œä»–è¶Šæ¥è¶ŠåŒå€¦è°ƒè¯•å…¶è¿è¡Œã€‚æ™ºèƒ½ä½“æœ¬è´¨ä¸Šæ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œéš¾ä»¥æ£€æŸ¥ã€‚ä½†ç”±äºä»–çš„ç›®æ ‡æ˜¯æ„å»ºç»ˆæåƒåœ¾é‚®ä»¶æ£€æµ‹æ™ºèƒ½ä½“å¹¶å°†å…¶éƒ¨ç½²åˆ°ç”Ÿäº§ä¸­ï¼Œå› æ­¤ä»–éœ€è¦å¼ºå¤§çš„å¯è¿½æº¯æ€§ä»¥ä¾›å°†æ¥ç›‘æ§å’Œåˆ†æã€‚

ä¸ºæ­¤ï¼ŒAlfred å¯ä»¥ä½¿ç”¨å¯è§‚å¯Ÿæ€§å·¥å…·ï¼ˆä¾‹å¦‚ [Langfuse](https://langfuse.com/)ï¼‰æ¥è·Ÿè¸ªå’Œç›‘æ§æ™ºèƒ½ä½“ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ pip install Langfuseï¼š
```python
%pip install -q langfuse
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°† Langfuse API å¯†é’¥å’Œä¸»æœºåœ°å€æ·»åŠ ä¸ºç¯å¢ƒå˜é‡ã€‚æ‚¨å¯ä»¥é€šè¿‡æ³¨å†Œ [Langfuse Cloud](https://cloud.langfuse.com) æˆ– [self-host Langfuse](https://langfuse.com/self-hosting) è·å– Langfuse å‡­æ®ã€‚

```python
import os
 
# Get keys for your project from the project settings page: https://cloud.langfuse.com
os.environ["LANGFUSE_PUBLIC_KEY"] = "pk-lf-..." 
os.environ["LANGFUSE_SECRET_KEY"] = "sk-lf-..."
os.environ["LANGFUSE_HOST"] = "https://cloud.langfuse.com" # ğŸ‡ªğŸ‡º EU region
# os.environ["LANGFUSE_HOST"] = "https://us.cloud.langfuse.com" # ğŸ‡ºğŸ‡¸ US region
```

ç„¶åï¼Œæˆ‘ä»¬é…ç½® [Langfuse `callback_handler`](https://langfuse.com/docs/integrations/langchain/tracing#add-langfuse-to-your-langchain-application)ï¼Œå¹¶é€šè¿‡å°† `langfuse_callback` æ·»åŠ åˆ°å›¾çš„è°ƒç”¨æ¥æ£€æµ‹æ™ºèƒ½ä½“ï¼š`config={"callbacks": [langfuse_handler]}`ã€‚

```python   
from langfuse.callback import CallbackHandler

# ä¸º LangGraph/Langchain åˆå§‹åŒ– Langfuse CallbackHandlerï¼ˆè·Ÿè¸ªï¼‰
langfuse_handler = CallbackHandler()

# å¤„ç†åˆæ³•ç”µå­é‚®ä»¶
legitimate_result = compiled_graph.invoke(
    input={"email": legitimate_email, "is_spam": None, "spam_reason": None, "email_category": None, "draft_response": None, "messages": []},
    config={"callbacks": [langfuse_handler]}
)
```

Alfred ç°å·²è¿æ¥ ğŸ”Œï¼LangGraph çš„è¿è¡Œè®°å½•åœ¨ Langfuse ä¸­ï¼Œä½¿ä»–èƒ½å¤Ÿå…¨é¢äº†è§£æ™ºèƒ½ä½“çš„è¡Œä¸ºã€‚é€šè¿‡æ­¤è®¾ç½®ï¼Œä»–å¯ä»¥é‡æ–°æŸ¥çœ‹ä¹‹å‰çš„è¿è¡Œå¹¶è¿›ä¸€æ­¥å®Œå–„ä»–çš„é‚®ä»¶åˆ†ç±»æ™ºèƒ½ä½“ã€‚

![Langfuse ä¸­çš„ç¤ºä¾‹è·Ÿè¸ª](https://langfuse.com/images/cookbook/huggingface-agent-course/langgraph-trace-legit.png)

_[å¸¦æœ‰åˆæ³•ç”µå­é‚®ä»¶çš„è·Ÿè¸ªçš„å…¬å…±é“¾æ¥](https://cloud.langfuse.com/project/cloramnkj0002jz088vzn1ja4/traces/f5d6d72e-20af-4357-b232-af44c3728a7b?timestamp=2025-03-17T10%3A13%3A28.413Z&observation=6997ba69-043f-4f77-9445-700a033afba1)_

## å¯è§†åŒ–æˆ‘ä»¬çš„å›¾è¡¨

LangGraph å…è®¸æˆ‘ä»¬å¯è§†åŒ–æˆ‘ä»¬çš„å·¥ä½œæµç¨‹ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£å’Œè°ƒè¯•å…¶ç»“æ„ï¼š

```python
compiled_graph.get_graph().draw_mermaid_png()
```
<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit2/LangGraph/mail_flow.png" alt="Mail LangGraph"/>

è¿™ä¼šäº§ç”Ÿä¸€ä¸ªå¯è§†åŒ–è¡¨ç¤ºï¼Œæ˜¾ç¤ºæˆ‘ä»¬çš„èŠ‚ç‚¹å¦‚ä½•è¿æ¥ä»¥åŠå¯ä»¥é‡‡å–çš„æ¡ä»¶è·¯å¾„ã€‚

## æˆ‘ä»¬æ„å»ºäº†ä»€ä¹ˆ

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ç”µå­é‚®ä»¶å¤„ç†å·¥ä½œæµç¨‹ï¼š

1. æ¥æ”¶ä¼ å…¥çš„ç”µå­é‚®ä»¶
2. ä½¿ç”¨ LLM å°†å…¶åˆ†ç±»ä¸ºåƒåœ¾é‚®ä»¶æˆ–åˆæ³•é‚®ä»¶
3. é€šè¿‡ä¸¢å¼ƒåƒåœ¾é‚®ä»¶æ¥å¤„ç†åƒåœ¾é‚®ä»¶
4. å¯¹äºåˆæ³•ç”µå­é‚®ä»¶ï¼Œèµ·è‰å›å¤å¹¶é€šçŸ¥ Mr. Hugg

è¿™å±•ç¤ºäº† LangGraph ä½¿ç”¨ LLM ç¼–æ’å¤æ‚å·¥ä½œæµç¨‹åŒæ—¶ä¿æŒæ¸…æ™°ã€ç»“æ„åŒ–æµç¨‹çš„å¼ºå¤§åŠŸèƒ½ã€‚

## å…³é”®è¦ç‚¹

- **çŠ¶æ€ç®¡ç†**ï¼šæˆ‘ä»¬å®šä¹‰äº†å…¨é¢çš„çŠ¶æ€æ¥è·Ÿè¸ªç”µå­é‚®ä»¶å¤„ç†çš„æ‰€æœ‰æ–¹é¢
- **èŠ‚ç‚¹å®ç°**ï¼šæˆ‘ä»¬åˆ›å»ºäº†ä¸ LLM äº¤äº’çš„åŠŸèƒ½èŠ‚ç‚¹
- **æ¡ä»¶è·¯ç”±**ï¼šæˆ‘ä»¬æ ¹æ®ç”µå­é‚®ä»¶åˆ†ç±»å®ç°äº†åˆ†æ”¯é€»è¾‘
- **ç»ˆç«¯çŠ¶æ€**ï¼šæˆ‘ä»¬ä½¿ç”¨ END èŠ‚ç‚¹æ ‡è®°å·¥ä½œæµç¨‹ä¸­çš„å®Œæˆç‚¹

## ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢ LangGraph çš„æ›´å¤šé«˜çº§åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤„ç†å·¥ä½œæµä¸­çš„äººæœºäº¤äº’ä»¥åŠæ ¹æ®å¤šç§æ¡ä»¶å®ç°æ›´å¤æ‚çš„åˆ†æ”¯é€»è¾‘ã€‚