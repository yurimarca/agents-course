# åˆ›å»ºå®¾å®¢ä¿¡æ¯æ£€ç´¢ç”Ÿæˆï¼ˆRAGï¼‰å·¥å…·

æ‚¨ä¿¡èµ–çš„æ™ºèƒ½ä½“ Alfred æ­£åœ¨ç­¹å¤‡æœ¬ä¸–çºªæœ€ç››å¤§çš„æ™šä¼šã€‚ä¸ºç¡®ä¿æ´»åŠ¨é¡ºåˆ©è¿›è¡Œï¼ŒAlfred éœ€è¦å¿«é€Ÿè·å–æœ€æ–°å®¾å®¢ä¿¡æ¯ã€‚è®©æˆ‘ä»¬é€šè¿‡å®šåˆ¶åŒ–çš„æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰å·¥å…·ï¼ˆåŸºäºä¸“å±æ•°æ®é›†ï¼‰ä¸º Alfred èµ‹èƒ½ã€‚

## ä¸ºä½•é€‰æ‹© RAG æŠ€æœ¯ï¼Ÿ

è¯•æƒ³ Alfred åœ¨å®¾å®¢é—´ç©¿æ¢­æ—¶éœ€å³æ—¶è°ƒå–è¯¦ç»†ä¿¡æ¯ï¼Œä¼ ç»Ÿå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å¯èƒ½é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š
1. å®¾å®¢åå•å±äºç‰¹å®šæ´»åŠ¨æ•°æ®ï¼Œä¸åœ¨æ¨¡å‹è®­ç»ƒèŒƒå›´å†…
2. å®¾å®¢ä¿¡æ¯å¯èƒ½é¢‘ç¹å˜æ›´æˆ–æ›´æ–°
3. éœ€ç²¾ç¡®æ£€ç´¢ç”µå­é‚®ä»¶åœ°å€ç­‰ç»†èŠ‚ä¿¡æ¯

è¿™æ­£æ˜¯æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰æŠ€æœ¯çš„ä¼˜åŠ¿æ‰€åœ¨ï¼é€šè¿‡ç»“åˆæ£€ç´¢ç³»ç»Ÿä¸ LLMï¼ŒAlfred å¯æŒ‰éœ€è·å–å‡†ç¡®ã€å®æ—¶çš„å®¾å®¢ä¿¡æ¯ã€‚

<Tip>
æ‚¨å¯ä»¥é€‰æ‹©è¯¾ç¨‹æ¶µç›–çš„ä»»ä½•æ¡†æ¶å®ç°æœ¬ç”¨ä¾‹ï¼Œè¯·é€šè¿‡ä»£ç æ ‡ç­¾é¡µé€‰æ‹©åå¥½æ–¹æ¡ˆã€‚
</Tip>

## åº”ç”¨æ­å»º

æˆ‘ä»¬å°†ä»¥ Hugging Face Space ä¸ºå¼€å‘ç¯å¢ƒï¼Œé‡‡ç”¨ç»“æ„åŒ– Python é¡¹ç›®æ„å»ºæ™ºèƒ½ä½“ã€‚è¿™ç§æ¶æ„é€šè¿‡åŠŸèƒ½æ¨¡å—åŒ–å®ç°ä»£ç æ•´æ´ï¼Œæ›´è´´è¿‘å®é™…éƒ¨ç½²åœºæ™¯ã€‚

### é¡¹ç›®ç»“æ„
- **`tools.py`** â€“ ä¸ºæ™ºèƒ½ä½“æä¾›è¾…åŠ©å·¥å…·  
- **`retriever.py`** â€“ å®ç°æ”¯æŒçŸ¥è¯†è®¿é—®çš„æ£€ç´¢åŠŸèƒ½  
- **`app.py`** â€“ æ•´åˆæ‰€æœ‰ç»„ä»¶å½¢æˆå®Œæ•´åŠŸèƒ½æ™ºèƒ½ä½“ï¼ˆå°†åœ¨æœ¬å•å…ƒæœ€åå®Œæˆï¼‰

å®æ“å‚è€ƒï¼š[Hugging Face Space ç¤ºä¾‹](https://huggingface.co/spaces/agents-course/Unit_3_Agentic_RAG)ï¼Œè¯¥ç©ºé—´å·²éƒ¨ç½²æœ¬å•å…ƒå¼€å‘çš„æ™ºèƒ½ä½“å¢å¼º RAG ç³»ç»Ÿï¼Œæ¬¢è¿å…‹éš†ä½“éªŒï¼

å¯ç›´æ¥æµ‹è¯•ä¸‹æ–¹æ™ºèƒ½ä½“ï¼š
<iframe
	src="https://agents-course-unit-3-agentic-rag.hf.space"
	frameborder="0"
	width="850"
	height="450"
></iframe>

## æ•°æ®é›†æ¦‚è§ˆ

æ•°æ®é›† [`agents-course/unit3-invitees`](https://huggingface.co/datasets/agents-course/unit3-invitees/) åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- **Name**: å®¾å®¢å…¨å
- **Relation**: ä¸ä¸»åŠæ–¹å…³ç³»
- **Description**: ç®€è¦ä¼ è®°æˆ–è¶£é—»
- **Email Address**: é‚€è¯·å‡½å‘é€åŠè·Ÿè¿›è”ç³»æ–¹å¼

æ•°æ®é›†é¢„è§ˆï¼š
<iframe
  src="https://huggingface.co/datasets/agents-course/unit3-invitees/embed/viewer/default/train"
  frameborder="0"
  width="100%"
  height="560px"
></iframe>

<Tip>
å®é™…åœºæ™¯å¯æ‰©å±•æ•°æ®é›†å­—æ®µï¼ŒåŒ…å«é¥®é£Ÿåå¥½ã€ç¤¼å“å…´è¶£ã€ç¦å¿Œè¯é¢˜ç­‰å¯¹ä¸»æŒäººæœ‰ç”¨çš„è¯¦ç»†ä¿¡æ¯ã€‚
</Tip>

## æ„å»ºå®¾å®¢ä¿¡æ¯å·¥å…·

æˆ‘ä»¬å°†åˆ›å»º Alfred åœ¨æ™šä¼šæœŸé—´å¿«é€Ÿæ£€ç´¢å®¾å®¢ä¿¡æ¯çš„å®šåˆ¶å·¥å…·ï¼Œåˆ†ä¸‰æ­¥å®ç°ï¼š
1. åŠ è½½å¹¶é¢„å¤„ç†æ•°æ®é›†
2. åˆ›å»ºæ£€ç´¢å·¥å…·
3. å·¥å…·ä¸ Alfred é›†æˆ

### æ­¥éª¤ä¸€ï¼šåŠ è½½å¹¶é¢„å¤„ç†æ•°æ®é›†

é¦–å…ˆå°†åŸå§‹å®¾å®¢æ•°æ®è½¬æ¢ä¸ºé€‚åˆæ£€ç´¢çš„æ ¼å¼ï¼š

<hfoptions id="agents-frameworks">
<hfoption id="smolagents">

```python
import datasets
from langchain.docstore.document import Document

# åŠ è½½æ•°æ®é›†
guest_dataset = datasets.load_dataset("agents-course/unit3-invitees", split="train")

# è½¬æ¢ä¸º Document å¯¹è±¡
docs = [
    Document(
        page_content="\n".join([
            f"Name: {guest['name']}",
            f"Relation: {guest['relation']}",
            f"Description: {guest['description']}",
            f"Email: {guest['email']}"
        ]),
        metadata={"name": guest["name"]}
    )
    for guest in guest_dataset
]

```

</hfoption>
<hfoption id="llama-index">

æˆ‘ä»¬å°†ä½¿ç”¨ Hugging Face `datasets` åº“æ¥åŠ è½½æ•°æ®é›†å¹¶å°†å…¶è½¬æ¢ä¸ºæ¥è‡ª `llama_index.core.schema` æ¨¡å—çš„ `Document` å¯¹è±¡åˆ—è¡¨ã€‚

```python
import datasets
from llama_index.core.schema import Document

# åŠ è½½æ•°æ®é›†
guest_dataset = datasets.load_dataset("agents-course/unit3-invitees", split="train")

# è½¬æ¢ä¸º Document å¯¹è±¡
docs = [
    Document(
        text="\n".join([
            f"Name: {guest_dataset['name'][i]}",
            f"Relation: {guest_dataset['relation'][i]}",
            f"Description: {guest_dataset['description'][i]}",
            f"Email: {guest_dataset['email'][i]}"
        ]),
        metadata={"name": guest_dataset['name'][i]}
    )
    for i in range(len(guest_dataset))
]
```

</hfoption>
<hfoption id="langgraph">

æˆ‘ä»¬å°†ä½¿ç”¨ Hugging Face `datasets` åº“æ¥åŠ è½½æ•°æ®é›†å¹¶å°†å…¶è½¬æ¢ä¸ºæ¥è‡ª `langchain.docstore.document` æ¨¡å—çš„ `Document` å¯¹è±¡åˆ—è¡¨ã€‚

```python
import datasets
from langchain.docstore.document import Document

# åŠ è½½æ•°æ®é›†
guest_dataset = datasets.load_dataset("agents-course/unit3-invitees", split="train")

# è½¬æ¢ä¸º Document å¯¹è±¡
docs = [
    Document(
        page_content="\n".join([
            f"Name: {guest['name']}",
            f"Relation: {guest['relation']}",
            f"Description: {guest['description']}",
            f"Email: {guest['email']}"
        ]),
        metadata={"name": guest["name"]}
    )
    for guest in guest_dataset
]
```

</hfoption>
</hfoptions>

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ï¼š
- åŠ è½½æ•°æ®é›†
- å°†æ¯æ¡æˆ¿å®¢è®°å½•è½¬æ¢ä¸ºåŒ…å«æ ¼å¼åŒ–å†…å®¹çš„ â€œDocumentâ€ å¯¹è±¡
- å°† â€œDocumentâ€ å¯¹è±¡å­˜å‚¨åœ¨åˆ—è¡¨ä¸­

è¿™æ„å‘³ç€æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½æ‰€æœ‰æ•°æ®ï¼Œå¯ä»¥å¼€å§‹é…ç½®æ£€ç´¢åŠŸèƒ½äº†ã€‚

### æ­¥éª¤ 2ï¼šåˆ›å»ºæ£€ç´¢å·¥å…·

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å·¥å…·ï¼ŒAlfred å¯ä»¥ä½¿ç”¨å®ƒæ¥æœç´¢æˆ¿å®¢ä¿¡æ¯ã€‚

<hfoptions id="agents-frameworks">
<hfoption id="smolagents">

æˆ‘ä»¬å°†ä½¿ç”¨â€œlangchain_community.retrieversâ€æ¨¡å—ä¸­çš„â€œBM25Retrieverâ€æ¥åˆ›å»ºä¸€ä¸ªæ£€ç´¢å·¥å…·ã€‚

<Tip>
<code>BM25Retriever</code> æ˜¯æ£€ç´¢çš„ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ï¼Œä½†å¯¹äºæ›´é«˜çº§çš„è¯­ä¹‰æœç´¢ï¼Œæ‚¨å¯ä»¥è€ƒè™‘ä½¿ç”¨åŸºäºåµŒå…¥çš„æ£€ç´¢å™¨ï¼Œä¾‹å¦‚æ¥è‡ª <a href="https://www.sbert.net/">sentence-transformers</a> çš„æ£€ç´¢å™¨ã€‚
</Tip>

```python
from smolagents import Tool
from langchain_community.retrievers import BM25Retriever

class GuestInfoRetrieverTool(Tool):
    name = "guest_info_retriever"
    description = "Retrieves detailed information about gala guests based on their name or relation."
    inputs = {
        "query": {
            "type": "string",
            "description": "The name or relation of the guest you want information about."
        }
    }
    output_type = "string"

    def __init__(self, docs):
        self.is_initialized = False
        self.retriever = BM25Retriever.from_documents(docs)

    def forward(self, query: str):
        results = self.retriever.get_relevant_documents(query)
        if results:
            return "\n\n".join([doc.page_content for doc in results[:3]])
        else:
            return "No matching guest information found."

# åˆå§‹åŒ–å·¥å…·
guest_info_tool = GuestInfoRetrieverTool(docs)
```

è®©æˆ‘ä»¬é€æ­¥äº†è§£è¿™ä¸ªå·¥å…·ï¼š
- `name` å’Œ `description` å¸®åŠ©æ™ºèƒ½ä½“äº†è§£ä½•æ—¶ä»¥åŠå¦‚ä½•ä½¿ç”¨æ­¤å·¥å…·
- `inputs` å®šä¹‰å·¥å…·æ‰€éœ€çš„å‚æ•°ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºæœç´¢æŸ¥è¯¢ï¼‰
- æˆ‘ä»¬ä½¿ç”¨ `BM25Retriever`ï¼Œè¿™æ˜¯ä¸€ç§å¼ºå¤§çš„æ–‡æœ¬æ£€ç´¢ç®—æ³•ï¼Œä¸éœ€è¦åµŒå…¥
- `forward` æ–¹æ³•å¤„ç†æŸ¥è¯¢å¹¶è¿”å›æœ€ç›¸å…³çš„å®¢äººä¿¡æ¯

</hfoption>
<hfoption id="llama-index">

æˆ‘ä»¬å°†ä½¿ç”¨ `llama_index.retrievers.bm25` æ¨¡å—ä¸­çš„ `BM25Retriever` æ¥åˆ›å»ºä¸€ä¸ªæ£€ç´¢å·¥å…·ã€‚

<Tip>
<code>BM25Retriever</code> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ£€ç´¢èµ·ç‚¹ï¼Œä½†å¯¹äºæ›´é«˜çº§çš„è¯­ä¹‰æœç´¢ï¼Œæ‚¨å¯ä»¥è€ƒè™‘ä½¿ç”¨åŸºäºåµŒå…¥çš„æ£€ç´¢å™¨ï¼Œä¾‹å¦‚ <a href="https://www.sbert.net/">sentence-transformers</a> ä¸­çš„æ£€ç´¢å™¨ã€‚
</Tip>

```python
from llama_index.core.tools import FunctionTool
from llama_index.retrievers.bm25 import BM25Retriever

bm25_retriever = BM25Retriever.from_defaults(nodes=docs)

def get_guest_info_retriever(query: str) -> str:
    """Retrieves detailed information about gala guests based on their name or relation."""
    results = bm25_retriever.retrieve(query)
    if results:
        return "\n\n".join([doc.text for doc in results[:3]])
    else:
        return "No matching guest information found."

# åˆå§‹åŒ–å·¥å…·
guest_info_tool = FunctionTool.from_defaults(get_guest_info_retriever)
```

è®©æˆ‘ä»¬é€æ­¥äº†è§£è¿™ä¸ªå·¥å…·ã€‚
- æ–‡æ¡£å­—ç¬¦ä¸²å¸®åŠ©æ™ºèƒ½ä½“äº†è§£ä½•æ—¶ä»¥åŠå¦‚ä½•ä½¿ç”¨æ­¤å·¥å…·
- ç±»å‹è£…é¥°å™¨å®šä¹‰äº†å·¥å…·æ‰€éœ€çš„å‚æ•°ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºæœç´¢æŸ¥è¯¢ï¼‰
- æˆ‘ä»¬ä½¿ç”¨ `BM25Retriever`ï¼Œè¿™æ˜¯ä¸€ç§å¼ºå¤§çš„æ–‡æœ¬æ£€ç´¢ç®—æ³•ï¼Œä¸éœ€è¦åµŒå…¥
- è¯¥æ–¹æ³•å¤„ç†æŸ¥è¯¢å¹¶è¿”å›æœ€ç›¸å…³çš„å®¢äººä¿¡æ¯

</hfoption>
<hfoption id="langgraph">

æˆ‘ä»¬å°†ä½¿ç”¨ `langchain_community.retrievers` æ¨¡å—ä¸­çš„ `BM25Retriever` æ¥åˆ›å»ºä¸€ä¸ªæ£€ç´¢å·¥å…·ã€‚

<Tip>
<code>BM25Retriever</code> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ£€ç´¢èµ·ç‚¹ï¼Œä½†å¯¹äºæ›´é«˜çº§çš„è¯­ä¹‰æœç´¢ï¼Œæ‚¨å¯ä»¥è€ƒè™‘ä½¿ç”¨åŸºäºåµŒå…¥çš„æ£€ç´¢å™¨ï¼Œä¾‹å¦‚ <a href="https://www.sbert.net/">sentence-transformers</a> ä¸­çš„æ£€ç´¢å™¨ã€‚
</Tip>

```python
from langchain_community.retrievers import BM25Retriever
from langchain.tools import Tool

bm25_retriever = BM25Retriever.from_documents(docs)

def extract_text(query: str) -> str:
    """Retrieves detailed information about gala guests based on their name or relation."""
    results = bm25_retriever.invoke(query)
    if results:
        return "\n\n".join([doc.page_content for doc in results[:3]])
    else:
        return "No matching guest information found."

guest_info_tool = Tool(
    name="guest_info_retriever",
    func=extract_text,
    description="Retrieves detailed information about gala guests based on their name or relation."
)
```

è®©æˆ‘ä»¬é€æ­¥äº†è§£è¿™ä¸ªå·¥å…·ã€‚
- `name` å’Œ `description` å¸®åŠ©æ™ºèƒ½ä½“äº†è§£ä½•æ—¶ä»¥åŠå¦‚ä½•ä½¿ç”¨æ­¤å·¥å…·ã€‚
- ç±»å‹è£…é¥°å™¨å®šä¹‰äº†å·¥å…·æ‰€éœ€çš„å‚æ•°ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºæœç´¢æŸ¥è¯¢ï¼‰ã€‚
- æˆ‘ä»¬ä½¿ç”¨ `BM25Retriever`ï¼Œè¿™æ˜¯ä¸€ç§å¼ºå¤§çš„æ–‡æœ¬æ£€ç´¢ç®—æ³•ï¼Œæ— éœ€åµŒå…¥ã€‚
- è¯¥æ–¹æ³•å¤„ç†æŸ¥è¯¢å¹¶è¿”å›æœ€ç›¸å…³çš„å®¢äººä¿¡æ¯ã€‚


</hfoption>
</hfoptions>

### æ­¥éª¤ 3ï¼šå°†å·¥å…·ä¸ Alfred é›†æˆ

æœ€åï¼Œè®©æˆ‘ä»¬åˆ›å»ºæ™ºèƒ½ä½“å¹¶ä¸ºå…¶é…å¤‡è‡ªå®šä¹‰å·¥å…·ï¼Œå°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ï¼š

<hfoptions id="agents-frameworks">
<hfoption id="smolagents">

```python
from smolagents import CodeAgent, HfApiModel

# åˆå§‹åŒ– Hugging Face æ¨¡å‹
model = HfApiModel()

# ä½¿ç”¨å®¾å®¢ä¿¡æ¯å·¥å…·åˆ›å»ºæˆ‘ä»¬çš„æ™šä¼šæ™ºèƒ½ä½“ Alfred
alfred = CodeAgent(tools=[guest_info_tool], model=model)

# Example query Alfred might receive during the gala
response = alfred.run("Tell me about our guest named 'Lady Ada Lovelace'.")

print("ğŸ© Alfred's Response:")
print(response)
```

é¢„æœŸè¾“å‡ºï¼š

```
ğŸ© Alfred's Response:
æ ¹æ®æˆ‘æ£€ç´¢åˆ°çš„ä¿¡æ¯ï¼Œè‰¾è¾¾Â·æ´›å¤«è±æ–¯å¤«äººæ˜¯ä¸€ä½å—äººå°Šæ•¬çš„æ•°å­¦å®¶å’Œæœ‹å‹ã€‚å¥¹å› å…¶åœ¨æ•°å­¦å’Œè®¡ç®—æœºé¢†åŸŸçš„å¼€åˆ›æ€§å·¥ä½œè€Œé—»åï¼Œå¹¶å› å…¶åœ¨æŸ¥å°”æ–¯Â·å·´è´å¥‡çš„åˆ†ææœºæ–¹é¢çš„è´¡çŒ®è€Œè¢«èª‰ä¸ºç¬¬ä¸€ä½è®¡ç®—æœºç¨‹åºå‘˜ã€‚å¥¹çš„ç”µå­é‚®ä»¶åœ°å€æ˜¯ ada.lovelace@example.comã€‚
```

è¿™æœ€åä¸€æ­¥å…·ä½“åšäº†ä»€ä¹ˆï¼š
- æˆ‘ä»¬ä½¿ç”¨ `HfApiModel` ç±»åˆå§‹åŒ– Hugging Face æ¨¡å‹
- æˆ‘ä»¬å°†æ™ºèƒ½ä½“ (Alfred) åˆ›å»ºä¸º `CodeAgent`ï¼Œå®ƒå¯ä»¥æ‰§è¡Œ Python ä»£ç æ¥è§£å†³é—®é¢˜
- æˆ‘ä»¬è®© Alfred æ£€ç´¢ä¸€ä½åå«â€œLady Ada Lovelaceâ€çš„å®¢äººçš„ä¿¡æ¯

</hfoption>
<hfoption id="llama-index">

```python
from llama_index.core.agent.workflow import AgentWorkflow
from llama_index.llms.huggingface_api import HuggingFaceInferenceAPI

# åˆå§‹åŒ– Hugging Face æ¨¡å‹
llm = HuggingFaceInferenceAPI(model_name="Qwen/Qwen2.5-Coder-32B-Instruct")

# ä½¿ç”¨å®¾å®¢ä¿¡æ¯å·¥å…·åˆ›å»ºæˆ‘ä»¬çš„æ™šä¼šæ™ºèƒ½ä½“ Alfred
alfred = AgentWorkflow.from_tools_or_functions(
    [guest_info_tool],
    llm=llm,
)

# Example query Alfred might receive during the gala
response = await alfred.run("Tell me about our guest named 'Lady Ada Lovelace'.")

print("ğŸ© Alfred's Response:")
print(response)
```

é¢„æœŸè¾“å‡ºï¼š

```
ğŸ© Alfred's Response:
Lady Ada Lovelace æ˜¯ä¸€ä½å—äººå°Šæ•¬çš„æ•°å­¦å®¶å’Œæœ‹å‹ï¼Œå› å…¶åœ¨æ•°å­¦å’Œè®¡ç®—é¢†åŸŸçš„å¼€åˆ›æ€§å·¥ä½œè€Œé—»åã€‚å¥¹å› å‚ä¸æŸ¥å°”æ–¯Â·å·´è´å¥‡çš„åˆ†ææœºç ”ç©¶è€Œè¢«èª‰ä¸ºç¬¬ä¸€ä½è®¡ç®—æœºç¨‹åºå‘˜ã€‚å¥¹çš„é‚®ç®±æ˜¯ ada.lovelace@example.comã€‚
```

è¿™æœ€åä¸€æ­¥å…·ä½“åšäº†ä»€ä¹ˆï¼š
- æˆ‘ä»¬ä½¿ç”¨ `HuggingFaceInferenceAPI` ç±»åˆå§‹åŒ– Hugging Face æ¨¡å‹
- æˆ‘ä»¬å°†æ™ºèƒ½ä½“ (Alfred) åˆ›å»ºä¸º `AgentWorkflow`ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„å·¥å…·
- æˆ‘ä»¬è¯·æ±‚ Alfred æ£€ç´¢åä¸ºâ€œLady Ada Lovelaceâ€çš„å®¢äººçš„ä¿¡æ¯

</hfoption>
<hfoption id="langgraph">

```python
from typing import TypedDict, Annotated
from langgraph.graph.message import add_messages
from langchain_core.messages import AnyMessage, HumanMessage, AIMessage
from langgraph.prebuilt import ToolNode
from langgraph.graph import START, StateGraph
from langgraph.prebuilt import tools_condition
from langchain_huggingface import HuggingFaceEndpoint, ChatHuggingFace

# ç”ŸæˆèŠå¤©ç•Œé¢ï¼ŒåŒ…æ‹¬å·¥å…·
llm = HuggingFaceEndpoint(
    repo_id="Qwen/Qwen2.5-Coder-32B-Instruct",
    huggingfacehub_api_token=HUGGINGFACEHUB_API_TOKEN,
)

chat = ChatHuggingFace(llm=llm, verbose=True)
tools = [guest_info_tool]
chat_with_tools = chat.bind_tools(tools)

# ç”Ÿæˆ AgentState å’Œ Agent å›¾
class AgentState(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]

def assistant(state: AgentState):
    return {
        "messages": [chat_with_tools.invoke(state["messages"])],
    }

## æ„å»ºæµç¨‹å›¾
builder = StateGraph(AgentState)

# å®šä¹‰èŠ‚ç‚¹ï¼šè¿™äº›èŠ‚ç‚¹å®Œæˆå·¥ä½œ
builder.add_node("assistant", assistant)
builder.add_node("tools", ToolNode(tools))

# å®šä¹‰è¾¹ï¼šè¿™äº›å†³å®šäº†æ§åˆ¶æµå¦‚ä½•ç§»åŠ¨
builder.add_edge(START, "assistant")
builder.add_conditional_edges(
    "assistant",
    # If the latest message requires a tool, route to tools
    # Otherwise, provide a direct response
    tools_condition,
)
builder.add_edge("tools", "assistant")
alfred = builder.compile()

messages = [HumanMessage(content="Tell me about our guest named 'Lady Ada Lovelace'.")]
response = alfred.invoke({"messages": messages})

print("ğŸ© Alfred's Response:")
print(response['messages'][-1].content)
```

é¢„æœŸè¾“å‡ºï¼š

```
ğŸ© Alfred's Response:
Lady Ada Lovelace æ˜¯ä¸€ä½å—äººå°Šæ•¬çš„æ•°å­¦å®¶å’Œè®¡ç®—æœºé¢†åŸŸçš„å…ˆé©±ï¼Œç”±äºå¥¹åœ¨æŸ¥å°”æ–¯Â·å·´è´å¥‡çš„åˆ†ææœºä¸Šæ‰€åšçš„å·¥ä½œï¼Œå¥¹ç»å¸¸è¢«èª‰ä¸ºç¬¬ä¸€ä½è®¡ç®—æœºç¨‹åºå‘˜ã€‚
```

è¿™æœ€åä¸€æ­¥å…·ä½“åšäº†ä»€ä¹ˆï¼š
- æˆ‘ä»¬ä½¿ç”¨ `HuggingFaceEndpoint` ç±»åˆå§‹åŒ– Hugging Face æ¨¡å‹ã€‚æˆ‘ä»¬è¿˜ç”Ÿæˆäº†ä¸€ä¸ªèŠå¤©ç•Œé¢å¹¶é™„åŠ äº†å·¥å…·ã€‚
- æˆ‘ä»¬å°†æ™ºèƒ½ä½“ (Alfred) åˆ›å»ºä¸ºä¸€ä¸ª `StateGraph`ï¼Œå®ƒä½¿ç”¨ä¸€æ¡è¾¹è¿æ¥ä¸¤ä¸ªèŠ‚ç‚¹ï¼ˆ`Assistant` å’Œ `tools`ï¼‰ã€‚
- æˆ‘ä»¬è®© Alfred æ£€ç´¢ä¸€ä½åå«â€œLady Ada Lovelaceâ€çš„å®¢äººçš„ä¿¡æ¯ã€‚

</hfoption>
</hfoptions>

## äº’åŠ¨ç¤ºä¾‹

åœ¨æ™šä¼šä¸Šï¼Œå¯¹è¯å¯èƒ½åƒè¿™æ ·è¿›è¡Œï¼š

**ä½ **ï¼šâ€œAlfredï¼Œé‚£ä½æ­£åœ¨å’Œå¤§ä½¿è¯´è¯çš„å…ˆç”Ÿæ˜¯è°ï¼Ÿâ€

**Alfred** *å¿«é€Ÿæœç´¢å˜‰å®¾æ•°æ®åº“* â€œå…ˆç”Ÿï¼Œé‚£æ˜¯å°¼å¤æ‹‰Â·ç‰¹æ–¯æ‹‰åšå£«ã€‚ä»–æ˜¯ä½ å¤§å­¦æ—¶ä»£çš„è€æœ‹å‹ã€‚ä»–æœ€è¿‘ç”³è¯·äº†ä¸€ç§æ–°çš„æ— çº¿èƒ½é‡ä¼ è¾“ç³»ç»Ÿçš„ä¸“åˆ©ï¼Œå¾ˆä¹æ„å’Œä½ è®¨è®ºä¸€ä¸‹ã€‚ä¸è¿‡åˆ«å¿˜äº†ï¼Œä»–å¯¹é¸½å­å¾ˆæ„Ÿå…´è¶£ï¼Œæ‰€ä»¥è¿™æˆ–è®¸ä¼šæˆä¸ºä¸€æ¬¡å¾ˆå¥½çš„é—²èŠã€‚â€

```json
{
    "name": "Dr. Nikola Tesla",
    "relation": "old friend from university days",  
    "description": "Dr. Nikola Tesla is an old friend from your university days. He's recently patented a new wireless energy transmission system and would be delighted to discuss it with you. Just remember he's passionate about pigeons, so that might make for good small talk.",
    "email": "nikola.tesla@gmail.com"
}
```

## æ›´è¿›ä¸€æ­¥

æ—¢ç„¶ Alfred å¯ä»¥æ£€ç´¢å®¾å®¢ä¿¡æ¯ï¼Œä¸å¦¨è€ƒè™‘å¦‚ä½•å¢å¼ºè¿™ä¸ªç³»ç»Ÿï¼š

1. **æ”¹è¿›æ£€ç´¢å™¨**ï¼Œä½¿ç”¨æ›´å¤æ‚çš„ç®—æ³•ï¼Œä¾‹å¦‚ [sentence-transformers](https://www.sbert.net/)
2. **å®ç°å¯¹è¯è®°å¿†**ï¼Œè®© Alfred è®°ä½ä¹‹å‰çš„äº’åŠ¨
3. **ç»“åˆç½‘é¡µæœç´¢**ï¼Œè·å–é™Œç”Ÿå®¾å®¢çš„æœ€æ–°ä¿¡æ¯
4. **æ•´åˆå¤šä¸ªç´¢å¼•**ï¼Œä»ç»è¿‡éªŒè¯çš„æ¥æºè·å–æ›´å®Œæ•´çš„ä¿¡æ¯

ç°åœ¨ï¼ŒAlfred å·²ç»å®Œå…¨æœ‰èƒ½åŠ›è½»æ¾å¤„ç†å®¾å®¢çš„å’¨è¯¢ï¼Œç¡®ä¿æ‚¨çš„æ™šä¼šæˆä¸ºæœ¬ä¸–çºªæœ€ç²¾è‡´ã€æœ€ä»¤äººæ„‰æ‚¦çš„ç››äº‹ï¼

<æç¤º>
å°è¯•æ‰©å±•æ£€ç´¢å·¥å…·ï¼Œä½¿å…¶èƒ½å¤Ÿæ ¹æ®æ¯ä½å®¾å®¢çš„å…´è¶£æˆ–èƒŒæ™¯è¿”å›å¯¹è¯å¼€åœºç™½ã€‚æ‚¨å°†å¦‚ä½•ä¿®æ”¹è¯¥å·¥å…·æ¥å®ç°è¿™ä¸€ç‚¹ï¼Ÿ

å®Œæˆåï¼Œåœ¨ <code>retriever.py</code> æ–‡ä»¶ä¸­å®ç°æ‚¨çš„å®¾å®¢æ£€ç´¢å·¥å…·ã€‚
</æç¤º>
