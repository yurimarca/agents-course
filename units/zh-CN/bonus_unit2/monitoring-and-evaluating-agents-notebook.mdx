<CourseFloatingBanner chapter={2}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/agents-course/blob/main/notebooks/bonus-unit2/monitoring-and-evaluating-agents.ipynb"},
]} />

# é™„åŠ å•å…ƒ 2ï¼šAI æ™ºèƒ½ä½“(AI Agent)çš„å¯è§‚æµ‹æ€§ä¸è¯„ä¼°

<Tip>
ä½ å¯ä»¥è·Ÿéš<a href="https://huggingface.co/agents-course/notebooks/blob/main/bonus-unit2/monitoring-and-evaluating-agents-notebook.ipynb" target="_blank">è¿™ä¸ª notebook</a> ä¸­çš„ä»£ç è¿›è¡Œæ“ä½œï¼Œä½ å¯ä»¥åœ¨ Google Colab ä¸Šè¿è¡Œå®ƒã€‚
</Tip>

åœ¨è¿™ä¸ª notebook ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨å¼€æºå¯è§‚æµ‹æ€§å·¥å…·æ¥**ç›‘ç£æˆ‘ä»¬ AI æ™ºèƒ½ä½“çš„å†…éƒ¨æ­¥éª¤ï¼ˆè¿½è¸ªï¼‰**å¹¶**è¯„ä¼°å…¶æ€§èƒ½**ã€‚

è§‚æµ‹å’Œè¯„ä¼°æ™ºèƒ½ä½“è¡Œä¸ºçš„èƒ½åŠ›å¯¹äºä»¥ä¸‹æ–¹é¢è‡³å…³é‡è¦ï¼š
- å½“ä»»åŠ¡å¤±è´¥æˆ–äº§ç”Ÿæ¬¡ä¼˜ç»“æœæ—¶è°ƒè¯•é—®é¢˜
- å®æ—¶è·Ÿè¸ªæˆæœ¬å’Œæ€§èƒ½
- é€šè¿‡æŒç»­åé¦ˆæé«˜å¯é æ€§å’Œå®‰å…¨æ€§

## ç»ƒä¹ å…ˆå†³æ¡ä»¶ ğŸ—ï¸

åœ¨è¿è¡Œæ­¤ notebook ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ å·²ç»ï¼š

ğŸ”² ğŸ“š  **å­¦ä¹ äº†** [æ™ºèƒ½ä½“ç®€ä»‹](https://huggingface.co/learn/agents-course/unit1/introduction)

ğŸ”² ğŸ“š  **å­¦ä¹ äº†** [smolagents æ¡†æ¶](https://huggingface.co/learn/agents-course/unit2/smolagents/introduction)

## æ­¥éª¤ 0ï¼šå®‰è£…æ‰€éœ€çš„åº“

æˆ‘ä»¬å°†éœ€è¦ä¸€äº›åº“ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿè¿è¡Œã€ç›‘æ§å’Œè¯„ä¼°æˆ‘ä»¬çš„æ™ºèƒ½ä½“ï¼š


```python
%pip install 'smolagents[telemetry]'
%pip install opentelemetry-sdk opentelemetry-exporter-otlp openinference-instrumentation-smolagents
%pip install langfuse datasets 'smolagents[gradio]'
```

## æ­¥éª¤ 1ï¼šæ£€æµ‹ä½ çš„æ™ºèƒ½ä½“

åœ¨è¿™ä¸ª notebook ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Langfuse](https://langfuse.com/) ä½œä¸ºæˆ‘ä»¬çš„å¯è§‚æµ‹æ€§å·¥å…·ï¼Œä½†ä½ å¯ä»¥ä½¿ç”¨**ä»»ä½•å…¶ä»–å…¼å®¹ OpenTelemetry çš„æœåŠ¡**ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•ä¸º Langfuseï¼ˆæˆ–ä»»ä½• OTel ç«¯ç‚¹ï¼‰è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä»¥åŠå¦‚ä½•æ£€æµ‹ä½ çš„ smolagentã€‚

**è¯·æ³¨æ„ï¼š** å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ LlamaIndex æˆ– LangGraphï¼Œä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://langfuse.com/docs/integrations/llama-index/workflows)å’Œ[è¿™é‡Œ](https://langfuse.com/docs/integrations/langchain/example-python-langgraph)æ‰¾åˆ°æ£€æµ‹å®ƒä»¬çš„æ–‡æ¡£ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬é…ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡ï¼Œä»¥è®¾ç½®åˆ° Langfuse OpenTelemetry ç«¯ç‚¹çš„è¿æ¥ã€‚

```python
import os
import base64

# ä» https://cloud.langfuse.com è·å–ä½ è‡ªå·±çš„å¯†é’¥
LANGFUSE_PUBLIC_KEY = "pk-lf-..."
LANGFUSE_SECRET_KEY = "sk-lf-..."
os.environ["LANGFUSE_PUBLIC_KEY"] = LANGFUSE_PUBLIC_KEY
os.environ["LANGFUSE_SECRET_KEY"] = LANGFUSE_SECRET_KEY
os.environ["LANGFUSE_HOST"] = "https://cloud.langfuse.com"  # ğŸ‡ªğŸ‡º æ¬§ç›ŸåŒºåŸŸç¤ºä¾‹
# os.environ["LANGFUSE_HOST"] = "https://us.cloud.langfuse.com"  # ğŸ‡ºğŸ‡¸ ç¾å›½åŒºåŸŸç¤ºä¾‹

LANGFUSE_AUTH = base64.b64encode(
    f"{LANGFUSE_PUBLIC_KEY}:{LANGFUSE_SECRET_KEY}".encode()
).decode()

os.environ["OTEL_EXPORTER_OTLP_ENDPOINT"] = os.environ.get("LANGFUSE_HOST") + "/api/public/otel"
os.environ["OTEL_EXPORTER_OTLP_HEADERS"] = f"Authorization=Basic {LANGFUSE_AUTH}"
```
æˆ‘ä»¬è¿˜éœ€è¦é…ç½®æˆ‘ä»¬çš„ Hugging Face token ç”¨äºæ¨ç†è°ƒç”¨ã€‚

```python
# å°†ä½ çš„ Hugging Face å’Œå…¶ä»– tokenæˆ–è€…å¯†é’¥è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
os.environ["HF_TOKEN"] = "hf_..."
```
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬é…ç½®çš„ OpenTelemetry è®¾ç½®ä¸€ä¸ª tracer-providerã€‚

```python
from opentelemetry.sdk.trace import TracerProvider
from openinference.instrumentation.smolagents import SmolagentsInstrumentor
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.trace.export import SimpleSpanProcessor

# ä¸º OpenTelemetry åˆ›å»ºä¸€ä¸ª TracerProvider
trace_provider = TracerProvider()

# æ·»åŠ ä¸€ä¸ªå¸¦æœ‰ OTLPSpanExporter çš„ SimpleSpanProcessor æ¥å‘é€è¿½è¸ª
trace_provider.add_span_processor(SimpleSpanProcessor(OTLPSpanExporter()))

# è®¾ç½®å…¨å±€é»˜è®¤ tracer provider
from opentelemetry import trace
trace.set_tracer_provider(trace_provider)
tracer = trace.get_tracer(__name__)

# ä½¿ç”¨é…ç½®çš„ provider æ£€æµ‹ smolagents
SmolagentsInstrumentor().instrument(tracer_provider=trace_provider)

```

## æ­¥éª¤ 2ï¼šæµ‹è¯•ä½ çš„æ£€æµ‹

è¿™é‡Œæœ‰ä¸€ä¸ªæ¥è‡ª smolagents çš„ç®€å• CodeAgentï¼Œç”¨äºè®¡ç®— `1+1`ã€‚æˆ‘ä»¬è¿è¡Œå®ƒæ¥ç¡®è®¤æ£€æµ‹æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚å¦‚æœä¸€åˆ‡è®¾ç½®æ­£ç¡®ï¼Œä½ å°†åœ¨ä½ çš„å¯è§‚æµ‹æ€§ä»ªè¡¨æ¿ä¸­çœ‹åˆ°æ—¥å¿—/è·¨åº¦ï¼ˆspansï¼‰ã€‚


```python
from smolagents import HfApiModel, CodeAgent

# åˆ›å»ºä¸€ä¸ªç®€å•çš„æ™ºèƒ½ä½“æ¥æµ‹è¯•æ£€æµ‹
agent = CodeAgent(
    tools=[],
    model=HfApiModel()
)

agent.run("1+1=")
```

æ£€æŸ¥ä½ çš„ [Langfuse Traces Dashboard](https://cloud.langfuse.com)ï¼ˆæˆ–ä½ é€‰æ‹©çš„å¯è§‚æµ‹æ€§å·¥å…·ï¼‰ä»¥ç¡®è®¤è·¨åº¦ï¼ˆspansï¼‰å’Œæ—¥å¿—å·²è¢«è®°å½•ã€‚

Langfuse ä¸­çš„ç¤ºä¾‹æˆªå›¾ï¼š

![Example trace in Langfuse](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/first-example-trace.png)

_[è¿½è¸ªé“¾æ¥](https://cloud.langfuse.com/project/cloramnkj0002jz088vzn1ja4/traces/1b94d6888258e0998329cdb72a371155?timestamp=2025-03-10T11%3A59%3A41.743Z)_

## æ­¥éª¤ 3ï¼šè§‚æµ‹å’Œè¯„ä¼°æ›´å¤æ‚çš„AIæ™ºèƒ½ä½“

æ—¢ç„¶ä½ å·²ç»ç¡®è®¤ä½ çš„æ£€æµ‹å·¥ä½œæ­£å¸¸ï¼Œè®©æˆ‘ä»¬å°è¯•ä¸€ä¸ªæ›´å¤æ‚çš„æŸ¥è¯¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°é«˜çº§æŒ‡æ ‡ï¼ˆtoken ä½¿ç”¨é‡ã€å»¶è¿Ÿã€æˆæœ¬ç­‰ï¼‰æ˜¯å¦‚ä½•è¢«è¿½è¸ªçš„ã€‚


```python
from smolagents import (CodeAgent, DuckDuckGoSearchTool, HfApiModel)

search_tool = DuckDuckGoSearchTool()
agent = CodeAgent(tools=[search_tool], model=HfApiModel())

agent.run("How many Rubik's Cubes could you fit inside the Notre Dame Cathedral?")
```

### è¿½è¸ªç»“æ„

å¤§å¤šæ•°å¯è§‚æµ‹æ€§å·¥å…·ä¼šè®°å½•ä¸€ä¸ª**è¿½è¸ªï¼ˆtraceï¼‰**ï¼Œå…¶ä¸­åŒ…å«**è·¨åº¦ï¼ˆspansï¼‰**ï¼Œæ¯ä¸ªè·¨åº¦ä»£è¡¨ä½ çš„æ™ºèƒ½ä½“é€»è¾‘çš„ä¸€ä¸ªæ­¥éª¤ã€‚åœ¨è¿™é‡Œï¼Œè¿½è¸ªåŒ…å«äº†æ•´ä½“çš„æ™ºèƒ½ä½“è¿è¡Œä»¥åŠç”¨äºä»¥ä¸‹å†…å®¹çš„å­è·¨åº¦ï¼š
- å·¥å…·è°ƒç”¨ (DuckDuckGoSearchTool)
- LLM è°ƒç”¨ (HfApiModel)

ä½ å¯ä»¥æ£€æŸ¥è¿™äº›è·¨åº¦ï¼Œä»¥ç²¾ç¡®åœ°äº†è§£æ—¶é—´èŠ±åœ¨å“ªé‡Œã€ä½¿ç”¨äº†å¤šå°‘ token ç­‰ç­‰ï¼š

Langfuse ä¸­çš„è¿½è¸ªæ ‘ï¼š

![Trace tree in Langfuse](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/trace-tree.png)

_[å‰å¾€è¿½è¸ªï¼ˆtraceï¼‰çš„é“¾æ¥](https://cloud.langfuse.com/project/cloramnkj0002jz088vzn1ja4/traces/1ac33b89ffd5e75d4265b62900c348ed?timestamp=2025-03-07T13%3A45%3A09.149Z&display=preview)_

## åœ¨çº¿è¯„ä¼°

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†åœ¨çº¿è¯„ä¼°å’Œç¦»çº¿è¯„ä¼°çš„åŒºåˆ«ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›‘æ§ä½ çš„æ™ºèƒ½ä½“å¹¶å®æ—¶è¯„ä¼°å®ƒã€‚

### ç”Ÿäº§ç¯å¢ƒä¸­è¦è¿½è¸ªçš„å¸¸è§æŒ‡æ ‡

1.  **æˆæœ¬** â€” smolagents æ£€æµ‹ä¼šæ•è· token ä½¿ç”¨é‡ï¼Œä½ å¯ä»¥é€šè¿‡ä¸ºæ¯ä¸ª token åˆ†é…ä»·æ ¼å°†å…¶è½¬æ¢ä¸ºè¿‘ä¼¼æˆæœ¬ã€‚
2.  **å»¶è¿Ÿ** â€” è§‚å¯Ÿå®Œæˆæ¯ä¸ªæ­¥éª¤æˆ–æ•´ä¸ªè¿è¡Œæ‰€éœ€çš„æ—¶é—´ã€‚
3.  **ç”¨æˆ·åé¦ˆ** â€” ç”¨æˆ·å¯ä»¥æä¾›ç›´æ¥åé¦ˆï¼ˆç‚¹èµ/ç‚¹è¸©ï¼‰æ¥å¸®åŠ©ä¼˜åŒ–æˆ–çº æ­£æ™ºèƒ½ä½“ã€‚
4.  **LLM ä½œä¸ºè¯„åˆ¤è€…** â€” ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ LLM æ¥è¿‘ä¹å®æ—¶åœ°è¯„ä¼°ä½ çš„æ™ºèƒ½ä½“çš„è¾“å‡ºï¼ˆä¾‹å¦‚ï¼Œæ£€æŸ¥æ¯’æ€§æˆ–æ­£ç¡®æ€§ï¼‰ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å±•ç¤ºè¿™äº›æŒ‡æ ‡çš„ç¤ºä¾‹ã€‚

#### 1. æˆæœ¬

ä¸‹é¢æ˜¯ä¸€ä¸ªæ˜¾ç¤º `Qwen2.5-Coder-32B-Instruct` è°ƒç”¨ä½¿ç”¨æƒ…å†µçš„æˆªå›¾ã€‚è¿™å¯¹äºæŸ¥çœ‹æˆæœ¬é«˜æ˜‚çš„æ­¥éª¤å¹¶ä¼˜åŒ–ä½ çš„æ™ºèƒ½ä½“å¾ˆæœ‰ç”¨ã€‚

![Costs](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/smolagents-costs.png)

_[å‰å¾€è¿½è¸ªï¼ˆtraceï¼‰çš„é“¾æ¥](https://cloud.langfuse.com/project/cloramnkj0002jz088vzn1ja4/traces/1ac33b89ffd5e75d4265b62900c348ed?timestamp=2025-03-07T13%3A45%3A09.149Z&display=preview)_

#### 2. å»¶è¿Ÿ

æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°å®Œæˆæ¯ä¸ªæ­¥éª¤æ‰€éœ€çš„æ—¶é—´ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæ•´ä¸ªå¯¹è¯èŠ±è´¹äº† 32 ç§’ï¼Œä½ å¯ä»¥æŒ‰æ­¥éª¤åˆ†è§£ã€‚è¿™æœ‰åŠ©äºä½ è¯†åˆ«ç“¶é¢ˆå¹¶ä¼˜åŒ–ä½ çš„æ™ºèƒ½ä½“ã€‚

![Latency](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/smolagents-latency.png)

_[å‰å¾€è¿½è¸ªï¼ˆtraceï¼‰çš„é“¾æ¥](https://cloud.langfuse.com/project/cloramnkj0002jz088vzn1ja4/traces/1ac33b89ffd5e75d4265b62900c348ed?timestamp=2025-03-07T13%3A45%3A09.149Z&display=preview)_

#### 3. é™„åŠ å±æ€§

ä½ è¿˜å¯ä»¥é€šè¿‡åœ¨è·¨åº¦ï¼ˆspansï¼‰ä¸Šè®¾ç½®é™„åŠ å±æ€§â€”â€”ä¾‹å¦‚ç”¨æˆ· IDã€ä¼šè¯ ID æˆ–æ ‡ç­¾ã€‚ä¾‹å¦‚ï¼Œsmolagents æ£€æµ‹ä½¿ç”¨ OpenTelemetry æ¥é™„åŠ è¯¸å¦‚ `langfuse.user.id` æˆ–è‡ªå®šä¹‰æ ‡ç­¾ä¹‹ç±»çš„å±æ€§ã€‚


```python
from smolagents import (CodeAgent, DuckDuckGoSearchTool, HfApiModel)
from opentelemetry import trace

search_tool = DuckDuckGoSearchTool()
agent = CodeAgent(
    tools=[search_tool],
    model=HfApiModel()
)

with tracer.start_as_current_span("Smolagent-Trace") as span:
    span.set_attribute("langfuse.user.id", "smolagent-user-123")
    span.set_attribute("langfuse.session.id", "smolagent-session-123456789")
    span.set_attribute("langfuse.tags", ["city-question", "testing-agents"])

    agent.run("What is the capital of Germany?")

```

![Enhancing agent runs with additional metrics](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/smolagents-attributes.png)

#### 4. ç”¨æˆ·åé¦ˆ

å¦‚æœä½ çš„æ™ºèƒ½ä½“åµŒå…¥åˆ°ç”¨æˆ·ç•Œé¢ä¸­ï¼Œä½ å¯ä»¥è®°å½•ç›´æ¥çš„ç”¨æˆ·åé¦ˆï¼ˆä¾‹å¦‚èŠå¤©ç•Œé¢ä¸­çš„ç‚¹èµ/ç‚¹è¸©ï¼‰ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨ [Gradio](https://gradio.app/) åµŒå…¥å¸¦æœ‰ç®€å•åé¦ˆæœºåˆ¶çš„èŠå¤©ç¤ºä¾‹ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œå½“ç”¨æˆ·å‘é€èŠå¤©æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬æ•è· OpenTelemetry è¿½è¸ª IDã€‚å¦‚æœç”¨æˆ·å–œæ¬¢/ä¸å–œæ¬¢ä¸Šä¸€ä¸ªç­”æ¡ˆï¼Œæˆ‘ä»¬å°†è¯„åˆ†é™„åŠ åˆ°è¯¥è¿½è¸ªä¸Šã€‚


```python
import gradio as gr
from opentelemetry.trace import format_trace_id
from smolagents import (CodeAgent, HfApiModel)
from langfuse import Langfuse

langfuse = Langfuse()
model = HfApiModel()
agent = CodeAgent(tools=[], model=model, add_base_tools=True)

formatted_trace_id = None  # ä¸ºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘ä»¬å°†åœ¨å…¨å±€å­˜å‚¨å½“å‰çš„ trace_id

def respond(prompt, history):
    with trace.get_tracer(__name__).start_as_current_span("Smolagent-Trace") as span:
        output = agent.run(prompt)

        current_span = trace.get_current_span()
        span_context = current_span.get_span_context()
        trace_id = span_context.trace_id
        global formatted_trace_id
        formatted_trace_id = str(format_trace_id(trace_id))
        langfuse.trace(id=formatted_trace_id, input=prompt, output=output)

    history.append({"role": "assistant", "content": str(output)})
    return history

def handle_like(data: gr.LikeData):
    # ä½œä¸ºæ¼”ç¤ºï¼Œæˆ‘ä»¬å°†ç”¨æˆ·åé¦ˆæ˜ å°„ä¸º 1 (å–œæ¬¢) æˆ– 0 (ä¸å–œæ¬¢)
    if data.liked:
        langfuse.score(
            value=1,
            name="user-feedback",
            trace_id=formatted_trace_id
        )
    else:
        langfuse.score(
            value=0,
            name="user-feedback",
            trace_id=formatted_trace_id
        )

with gr.Blocks() as demo:
    chatbot = gr.Chatbot(label="Chat", type="messages")
    prompt_box = gr.Textbox(placeholder="Type your message...", label="Your message")

    # å½“ç”¨æˆ·åœ¨æç¤ºæ¡†ä¸ŠæŒ‰ 'Enter' æ—¶ï¼Œæˆ‘ä»¬è¿è¡Œ 'respond'
    prompt_box.submit(
        fn=respond,
        inputs=[prompt_box, chatbot],
        outputs=chatbot
    )

    # å½“ç”¨æˆ·ç‚¹å‡»æ¶ˆæ¯ä¸Šçš„ 'å–œæ¬¢' æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬è¿è¡Œ 'handle_like'
    chatbot.like(handle_like, None, None)

demo.launch()

```

ç„¶åï¼Œç”¨æˆ·åé¦ˆä¼šè¢«æ•è·åˆ°ä½ çš„å¯è§‚æµ‹æ€§å·¥å…·ä¸­ï¼š

![User feedback is being captured in Langfuse](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/user-feedback-gradio.png)

#### 5. LLM ä½œä¸ºè¯„åˆ¤è€…

LLM ä½œä¸ºè¯„åˆ¤è€…ï¼ˆLLM-as-a-Judgeï¼‰æ˜¯å¦ä¸€ç§è‡ªåŠ¨è¯„ä¼°ä½ çš„æ™ºèƒ½ä½“è¾“å‡ºçš„æ–¹æ³•ã€‚ä½ å¯ä»¥è®¾ç½®ä¸€ä¸ªå•ç‹¬çš„ LLM è°ƒç”¨æ¥è¡¡é‡è¾“å‡ºçš„æ­£ç¡®æ€§ã€æ¯’æ€§ã€é£æ ¼æˆ–ä½ å…³å¿ƒçš„ä»»ä½•å…¶ä»–æ ‡å‡†ã€‚

**å·¥ä½œæµç¨‹**ï¼š
1.  ä½ å®šä¹‰ä¸€ä¸ª**è¯„ä¼°æ¨¡æ¿**ï¼Œä¾‹å¦‚ï¼Œâ€œæ£€æŸ¥æ–‡æœ¬æ˜¯å¦æœ‰æ¯’ã€‚â€
2.  æ¯æ¬¡ä½ çš„æ™ºèƒ½ä½“ç”Ÿæˆè¾“å‡ºæ—¶ï¼Œä½ å°†è¯¥è¾“å‡ºè¿åŒæ¨¡æ¿ä¸€èµ·ä¼ é€’ç»™ä½ çš„â€œè¯„åˆ¤è€…â€ LLMã€‚
3.  è¯„åˆ¤è€… LLM ä¼šè¿”å›ä¸€ä¸ªè¯„åˆ†æˆ–æ ‡ç­¾ï¼Œä½ å°†å…¶è®°å½•åˆ°ä½ çš„å¯è§‚æµ‹æ€§å·¥å…·ä¸­ã€‚

æ¥è‡ª Langfuse çš„ç¤ºä¾‹ï¼š


![LLM-as-a-Judge Evaluation Template](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/evaluator-template.png)
![LLM-as-a-Judge Evaluator](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/evaluator.png)


```python
# ç¤ºä¾‹ï¼šæ£€æŸ¥æ™ºèƒ½ä½“çš„è¾“å‡ºæ˜¯å¦æœ‰æ¯’ã€‚
from smolagents import (CodeAgent, DuckDuckGoSearchTool, HfApiModel)

search_tool = DuckDuckGoSearchTool()
agent = CodeAgent(tools=[search_tool], model=HfApiModel())

agent.run("Can eating carrots improve your vision?")

```

ä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªä¾‹å­çš„ç­”æ¡ˆè¢«åˆ¤å®šä¸ºâ€œæ— æ¯’â€ã€‚

![LLM-as-a-Judge Evaluation Score](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/llm-as-a-judge-score.png)

#### 6. å¯è§‚æµ‹æ€§æŒ‡æ ‡æ¦‚è§ˆ

æ‰€æœ‰è¿™äº›æŒ‡æ ‡éƒ½å¯ä»¥åœ¨ä»ªè¡¨æ¿ä¸­ä¸€èµ·å¯è§†åŒ–ã€‚è¿™ä½¿ä½ èƒ½å¤Ÿå¿«é€ŸæŸ¥çœ‹ä½ çš„æ™ºèƒ½ä½“åœ¨å¤šä¸ªä¼šè¯ä¸­çš„è¡¨ç°ï¼Œå¹¶å¸®åŠ©ä½ éšæ—¶é—´è¿½è¸ªè´¨é‡æŒ‡æ ‡ã€‚

![Observability metrics overview](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/langfuse-dashboard.png)

## ç¦»çº¿è¯„ä¼°

åœ¨çº¿è¯„ä¼°å¯¹äºå®æ—¶åé¦ˆè‡³å…³é‡è¦ï¼Œä½†ä½ è¿˜éœ€è¦**ç¦»çº¿è¯„ä¼°**â€”â€”åœ¨å¼€å‘ä¹‹å‰æˆ–æœŸé—´è¿›è¡Œç³»ç»Ÿæ€§æ£€æŸ¥ã€‚è¿™æœ‰åŠ©äºåœ¨å°†æ›´æ”¹æ¨é€åˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰ç»´æŠ¤è´¨é‡å’Œå¯é æ€§ã€‚

### æ•°æ®é›†è¯„ä¼°

åœ¨ç¦»çº¿è¯„ä¼°ä¸­ï¼Œä½ é€šå¸¸ï¼š
1.  æ‹¥æœ‰ä¸€ä¸ªåŸºå‡†æ•°æ®é›†ï¼ˆåŒ…å«æç¤ºå’Œé¢„æœŸè¾“å‡ºå¯¹ï¼‰
2.  åœ¨è¯¥æ•°æ®é›†ä¸Šè¿è¡Œä½ çš„æ™ºèƒ½ä½“
3.  å°†è¾“å‡ºä¸é¢„æœŸç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œæˆ–ä½¿ç”¨é¢å¤–çš„è¯„åˆ†æœºåˆ¶

ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ [GSM8K æ•°æ®é›†](https://huggingface.co/datasets/gsm8k) æ¥æ¼”ç¤ºè¿™ç§æ–¹æ³•ï¼Œè¯¥æ•°æ®é›†åŒ…å«æ•°å­¦é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚


```python
import pandas as pd
from datasets import load_dataset

# ä» Hugging Face è·å– GSM8K
dataset = load_dataset("openai/gsm8k", 'main', split='train')
df = pd.DataFrame(dataset)
print("GSM8K æ•°æ®é›†çš„å‰å‡ è¡Œï¼š")
print(df.head())

```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ Langfuse ä¸­åˆ›å»ºä¸€ä¸ªæ•°æ®é›†å®ä½“æ¥è¿½è¸ªè¿è¡Œã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ•°æ®é›†ä¸­çš„æ¯ä¸ªé¡¹ç›®æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚ï¼ˆå¦‚æœä½ ä¸ä½¿ç”¨ Langfuseï¼Œä½ å¯ä»¥ç®€å•åœ°å°†è¿™äº›å­˜å‚¨åœ¨ä½ è‡ªå·±çš„æ•°æ®åº“æˆ–æœ¬åœ°æ–‡ä»¶ä¸­è¿›è¡Œåˆ†æã€‚ï¼‰


```python
from langfuse import Langfuse
langfuse = Langfuse()

langfuse_dataset_name = "gsm8k_dataset_huggingface"

# åœ¨ Langfuse ä¸­åˆ›å»ºæ•°æ®é›†
langfuse.create_dataset(
    name=langfuse_dataset_name,
    description="ä» Huggingface ä¸Šä¼ çš„ GSM8K åŸºå‡†æ•°æ®é›†",
    metadata={
        "date": "2025-03-10",
        "type": "benchmark"
    }
)

```


```python
for idx, row in df.iterrows():
    langfuse.create_dataset_item(
        dataset_name=langfuse_dataset_name,
        input={"text": row["question"]},
        expected_output={"text": row["answer"]},
        metadata={"source_index": idx}
    )
    if idx >= 9: # ä»…ä¸Šä¼ å‰ 10 ä¸ªé¡¹ç›®ç”¨äºæ¼”ç¤º
        break

```

![Dataset items in Langfuse](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/example-dataset.png)

#### åœ¨æ•°æ®é›†ä¸Šè¿è¡Œæ™ºèƒ½ä½“

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•° `run_smolagent()`ï¼Œå®ƒï¼š
1.  å¯åŠ¨ä¸€ä¸ª OpenTelemetry è·¨åº¦ï¼ˆspanï¼‰
2.  åœ¨æç¤ºä¸Šè¿è¡Œæˆ‘ä»¬çš„æ™ºèƒ½ä½“
3.  åœ¨ Langfuse ä¸­è®°å½•è¿½è¸ª ID

ç„¶åï¼Œæˆ‘ä»¬éå†æ¯ä¸ªæ•°æ®é›†é¡¹ç›®ï¼Œè¿è¡Œæ™ºèƒ½ä½“ï¼Œå¹¶å°†è¿½è¸ªé“¾æ¥åˆ°æ•°æ®é›†é¡¹ç›®ã€‚å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é™„åŠ ä¸€ä¸ªå¿«é€Ÿè¯„ä¼°åˆ†æ•°ã€‚


```python
from opentelemetry.trace import format_trace_id
from smolagents import (CodeAgent, HfApiModel, LiteLLMModel)

# ç¤ºä¾‹ï¼šä½¿ç”¨ HfApiModel æˆ– LiteLLMModel è®¿é—® openaiã€anthropicã€gemini ç­‰æ¨¡å‹ï¼š
model = HfApiModel()

agent = CodeAgent(
    tools=[],
    model=model,
    add_base_tools=True
)

def run_smolagent(question):
    with tracer.start_as_current_span("Smolagent-Trace") as span:
        span.set_attribute("langfuse.tag", "dataset-run")
        output = agent.run(question)

        current_span = trace.get_current_span()
        span_context = current_span.get_span_context()
        trace_id = span_context.trace_id
        formatted_trace_id = format_trace_id(trace_id)

        langfuse_trace = langfuse.trace(
            id=formatted_trace_id,
            input=question,
            output=output
        )
    return langfuse_trace, output

```


```python
dataset = langfuse.get_dataset(langfuse_dataset_name)

# é’ˆå¯¹æ¯ä¸ªæ•°æ®é›†é¡¹ç›®è¿è¡Œæˆ‘ä»¬çš„æ™ºèƒ½ä½“ï¼ˆä¸Šé¢é™åˆ¶ä¸ºå‰ 10 ä¸ªï¼‰
for item in dataset.items:
    langfuse_trace, output = run_smolagent(item.input["text"])

    # å°†è¿½è¸ªé“¾æ¥åˆ°æ•°æ®é›†é¡¹ç›®ä»¥ä¾›åˆ†æ
    item.link(
        langfuse_trace,
        run_name="smolagent-notebook-run-01",
        run_metadata={ "model": model.model_id }
    )

    # å¯é€‰åœ°ï¼Œå­˜å‚¨ä¸€ä¸ªå¿«é€Ÿè¯„ä¼°åˆ†æ•°ç”¨äºæ¼”ç¤º
    langfuse_trace.score(
        name="<example_eval>",
        value=1,
        comment="è¿™æ˜¯ä¸€æ¡è¯„è®º"
    )

# åˆ·æ–°æ•°æ®ä»¥ç¡®ä¿æ‰€æœ‰é¥æµ‹æ•°æ®éƒ½å·²å‘é€
langfuse.flush()

```

ä½ å¯ä»¥ç”¨ä¸åŒçš„é…ç½®é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼š
- æ¨¡å‹ (OpenAI GPT, æœ¬åœ° LLM ç­‰)
- å·¥å…· (ä½¿ç”¨æœç´¢ vs. ä¸ä½¿ç”¨æœç´¢)
- æç¤º (ä¸åŒçš„ç³»ç»Ÿæ¶ˆæ¯)

ç„¶ååœ¨ä½ çš„å¯è§‚æµ‹æ€§å·¥å…·ä¸­å¹¶æ’æ¯”è¾ƒå®ƒä»¬ï¼š

![Dataset run overview](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/dataset_runs.png)
![Dataset run comparison](https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/bonus-unit2/dataset-run-comparison.png)


## ç»“è¯­

åœ¨è¿™ä¸ª notebook ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ï¼š
1.  **è®¾ç½®å¯è§‚æµ‹æ€§** ä½¿ç”¨ smolagents + OpenTelemetry å¯¼å‡ºå™¨
2.  **æ£€æŸ¥æ£€æµ‹** é€šè¿‡è¿è¡Œä¸€ä¸ªç®€å•çš„æ™ºèƒ½ä½“
3.  **æ•è·è¯¦ç»†æŒ‡æ ‡** (æˆæœ¬ã€å»¶è¿Ÿç­‰) é€šè¿‡å¯è§‚æµ‹æ€§å·¥å…·
4.  **æ”¶é›†ç”¨æˆ·åé¦ˆ** é€šè¿‡ Gradio ç•Œé¢
5.  **ä½¿ç”¨ LLM ä½œä¸ºè¯„åˆ¤è€…** è‡ªåŠ¨è¯„ä¼°è¾“å‡º
6.  **æ‰§è¡Œç¦»çº¿è¯„ä¼°** ä½¿ç”¨åŸºå‡†æ•°æ®é›†

ğŸ¤— ç¼–ä»£ç æ„‰å¿«ï¼